# jendeley v2 - インクリメンタルな曖昧検索の手法とその実装 <!-- omit in toc -->

[jendeley](https://zenn.dev/a_kawashiro/articles/a2170f967f9508)という JSON ベースの文書管理ソフトウェアを作って日々使っています。先日、バージョン 2 にアップデートするに当たって、長らく欲しかった文書全体に対するインクリメンタルな曖昧検索機能を実装しました。

## 目次 <!-- omit in toc -->

- [jendeley とは](#jendeleyとは)
- [インクリメンタルな曖昧検索](#インクリメンタルな曖昧検索)
  - [インクリメンタルな曖昧検索とは](#インクリメンタルな曖昧検索とは)
  - [jendeley での動作の様子](#jendeleyでの動作の様子)
  - [求められる性能](#求められる性能)
- [インクリメンタル全文ファジー検索の実装](#インクリメンタル全文ファジー検索の実装)
  - [ナイーブな実装](#ナイーブな実装)
  - [接尾辞木を用いた実装](#接尾辞木を用いた実装)
    - [Ukkonen のアルゴリズムを用いた接尾辞木の構築](#ukkonenのアルゴリズムを用いた接尾辞木の構築)
- [まとめ](#まとめ)
- [参考](#参考)
- [連絡先](#連絡先)

## jendeley とは

まずはじめに jendeley を簡単に紹介します。jendeley とは僕が作っている文書管理ソフトウェアです。

- データベースをプレインな JSON で保持すること
- サーバではなくローカルの PC で動作すること
- node.js とブラウザが動く環境なら OS を問わずどこでも動作すること

の 3 つの原則のもとに開発しています。半年ほど前の 2022 年 11 月に開発を開始し、先日 v2.0 をリリースしました。

2022 年 1 月にリリースした jendeley v1.0 はタイトル、著者、ユーザの付与したタグ、ユーザの書いたコメントに対してキーワードで文書を絞り込むことができました。しかし文書の中身に対して検索を行うことはできませんでした。

僕は昔から[検索エンジンを自作する](https://a-kawashiro.hatenablog.com/entry/2020/03/06/192527)ことに興味がありこともあり、jendeley に全文検索を実装したいと思っていました。更に、常日頃から[fzf](https://github.com/junegunn/fzf)というファジー検索ツールを常用していることもあり、実装するなら文書全体に対するインクリメンタルな曖昧検索を実装したいと考えていました。

## インクリメンタルな曖昧検索

### インクリメンタルな曖昧検索とは

「インクリメンタルな曖昧検索」とは、文字を一文字打つごとに新たに検索が行われ、また入力したキーワードに完全に一致しなくてもマッチするような検索のことです。[fzf](https://github.com/junegunn/fzf)は CLI で動作するインクリメンタルな曖昧検索ツールであり、ターミナルに組み込んで履歴の検索を行ったり、vim に組み込んでカレントディレクトリ以下のソースコードを検索することができます。

TODO: gif
上の画像は[sold](https://github.com/akawashiro/sold)のソースコードを fzf を使って全文検索している様子です。fzf は曖昧検索ができるので"Elf hash"で検索して CH**E**CK(fte**l**l(**f**p) == gnu\_**hash**\_fileoffset); がヒットしています。また一文字入力するごとに検索結果が変わっています。このインクリメンタルな曖昧検索は非常に便利で、僕はファイル検索、キーワード検索、コマンドの履歴検索を日常的に使っています。

### jendeley のインクリメンタルな曖昧検索機能

jendeley は v2.0.0 でインクリメンタルな曖昧検索を実装しました。登録した文書の本文、タイトル、著者全てに対してインクリメンタルな曖昧検索を行うことができます。下の画像は実際にインクリメンタルな曖昧検索を行っている様子です。
TODO: gif

## jendeley のインクリメンタル全文ファジー検索の実装

### 求められる性能
実装について説明する前にjendeleyの インクリメンタル全文ファジー検索機能に求められる性能を説明します。

まず、検索対象となる文字列のサイズです。現在、僕のjendeleyのデータベースのサイズは117MByteあり、その大部分が登録した文書の本文です。少なく見積もっても 20万文字程度あるでしょう。
```
$ ls -alh jendeley_db.json 
-rw-r--r-- 1 akira akira 117M  5月 26 21:47 jendeley_db.json
```

次に応答時間です。一般的なディスプレイが60Hz、アニメーションは24FPS(=24Hz)であることを考えると、まあ10Hz、つまり100msで応答できれば人間にはインクリメントに検索できるように見えるだろうと判断しました。

### ナイーブな実装
fzfで使われいるアルゴリズムをそのまま実装すると、テキストの長さをn、クエリの長さをkとしてO(nk)かかることがわかりました。この実装をjendeleyに実際に組み込んでみたところ、応答に1秒以上かかることがあり、使い物になりませんでした。

### 接尾辞木を用いた実装

#### Ukkonen のアルゴリズムを用いた接尾辞木の構築

## まとめ

## 参考

## 連絡先

この記事に誤りがあった場合は[Twitter](https://twitter.com/a_kawashiro)等で連絡をください。修正します。その他の連絡先は [https://akawashiro.github.io/](https://akawashiro.github.io/#links) にあります。
