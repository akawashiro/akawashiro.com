# jendeley v2 - インクリメンタルな曖昧検索の手法とその実装 <!-- omit in toc -->

[jendeley](https://zenn.dev/a_kawashiro/articles/a2170f967f9508)という JSON ベースの文書管理ソフトウェアを作って日々使っています。先日、バージョン 2 にアップデートするに当たって、長らく欲しかった文書全体に対するインクリメンタルな曖昧検索機能を実装しました。

## 目次 <!-- omit in toc -->

- [jendeley とは](#jendeley-とは)
- [インクリメンタルな曖昧検索](#インクリメンタルな曖昧検索)
  - [インクリメンタルな曖昧検索とは](#インクリメンタルな曖昧検索とは)
  - [jendeley のインクリメンタルな曖昧検索機能](#jendeley-のインクリメンタルな曖昧検索機能)
- [jendeley のインクリメンタルファジー検索の実装](#jendeley-のインクリメンタルファジー検索の実装)
  - [求められる性能](#求められる性能)
  - [ナイーブな実装](#ナイーブな実装)
  - [接尾辞木を用いた実装](#接尾辞木を用いた実装)
    - [Ukkonen のアルゴリズムを用いた接尾辞木の構築](#ukkonen-のアルゴリズムを用いた接尾辞木の構築)
- [まとめ](#まとめ)
- [参考](#参考)
- [連絡先](#連絡先)

## jendeley とは

まずはじめに jendeley を簡単に紹介します。jendeley とは僕が作っている文書管理ソフトウェアです。

- データベースをプレインな JSON で保持すること
- サーバではなくローカルの PC で動作すること
- node.js とブラウザが動く環境なら OS を問わずどこでも動作すること

の 3 つの原則のもとに開発しています。半年ほど前の 2022 年 11 月に開発を開始し、先日 v2.0 をリリースしました。2022 年 1 月にリリースした jendeley v1.0 はタイトル、著者、ユーザの付与したタグ、ユーザの書いたコメントに対してキーワードで文書を絞り込むことができました。しかし文書の中身に対して検索を行うことはできませんでした。

僕は昔から[検索エンジンを自作する](https://a-kawashiro.hatenablog.com/entry/2020/03/06/192527)ことに興味がありこともあり、jendeley に全文検索を実装したいと思っていました。更に、常日頃から[fzf](https://github.com/junegunn/fzf)というファジー検索ツールを常用していることもあり、実装するなら文書全体に対するインクリメンタルな曖昧検索を実装したいと考えていました。

## インクリメンタルな曖昧検索

### インクリメンタルな曖昧検索とは

「インクリメンタルな曖昧検索」とは、文字を一文字打つごとに新たに検索が行われ、また入力したキーワードに完全に一致しなくてもマッチするような検索のことです。[fzf](https://github.com/junegunn/fzf)は CLI で動作するインクリメンタルな曖昧検索ツールであり、ターミナルに組み込んで履歴の検索を行ったり、vim に組み込んでカレントディレクトリ以下のソースコードを検索することができます。

<img src="./fzf-search-at-sold.gif" width="800">

上の画像は[sold](https://github.com/akawashiro/sold)のソースコードを fzf を使って全文検索している様子です。曖昧検索なので完全に一致していない行もマッチしています。また、インクリメンタルな検索なので、一文字入力するごとに検索結果が更新されています。

このインクリメンタルな曖昧検索は非常に便利で、僕はファイル検索、キーワード検索、コマンドの履歴を検索するショートカットを登録し、重用しています。

### jendeley のインクリメンタルな曖昧検索機能

jendeley は v2.0.0 でインクリメンタルな曖昧検索を実装しました。登録した文書の本文、タイトル、著者全てに対してインクリメンタルな曖昧検索を行うことができます。下の画像は実際にインクリメンタルな曖昧検索を行っている様子です。"Type theory"という検索クエリで検索していますが、1文字打つごとに全文検索の結果が変わっています。また、マッチした部分を太文字で表示し、その周囲の文字列も表示します。そのため、文書の中でそのクエリがどのような文脈で使われているかが瞬時にわかります。
<img src="./jendeley-search-type-theory.gif" width="800">

## jendeley のインクリメンタルファジー検索の実装

### 求められる性能
実装について説明する前にjendeleyのインクリメンタルな曖昧検索に求められる性能を説明します。

まず、検索対象となる文字列のサイズです。現在、僕のjendeleyのデータベースのサイズは117MByteあり、その大部分が登録した文書の本文です。少なく見積もっても20万文字程度あります。
```
$ ls -alh jendeley_db.json 
-rw-r--r-- 1 akira akira 117M  5月 26 21:47 jendeley_db.json
```

次に応答時間です。今回は100ms以内に応答を返すことを目標に設定しました。

### ナイーブな実装
fzfで使われている検索アルゴリズムは[fzfのスコア計算を読んでみる](https://en-jp.wantedly.com/companies/wantedly/post_articles/306103)で解説されています。このアルゴリズムは動的計画法で、文書の長さ$n$、クエリの長さ$k$のとき$O(nk)$で動作します。

このアルゴリズムを実装し、実際にjendeleyで使ってみたところ、応答に1秒以上かかることがありました。これではインクリメンタルな検索とは言い難いです。動的計画法のテーブルを部分的に構築するなどの工夫もしてみたのですが、一文字打つごとに$O(n)$の計算量がかかることが致命的で、小手先の改善ではインクリメンタルな検索は実現できないと判断しました。

### 接尾辞木を用いた実装

#### Ukkonen のアルゴリズムを用いた接尾辞木の構築

## まとめ

## 参考

## 連絡先

この記事に誤りがあった場合は[Twitter](https://twitter.com/a_kawashiro)等で連絡をください。修正します。その他の連絡先は [https://akawashiro.github.io/](https://akawashiro.github.io/#links) にあります。
