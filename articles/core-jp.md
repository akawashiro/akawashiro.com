# core ファイル

- 範囲外アクセスで core ファイルを生成する C のプログラムをつくる。
- 解析を簡単にするため、範囲外アクセスの前に `/proc/self/maps` を出力しておく。

```c
#include <stdint.h>
#include <stdio.h>

uint64_t a = 0xaaaabbbbccccdddd;

int main() {
  // Print all lines in /proc/self/maps
  FILE *fp = fopen("/proc/self/maps", "r");
  char buf[0x1000];
  while (fgets(buf, sizeof(buf), fp)) {
    printf("%s", buf);
  }
  fclose(fp);

  for (size_t i = 0; i < 0x100000; i++) {
    *(&a + i) = 0xdeadbeefdeadbeef;
  }
}
```

- コンパイルする。

```bash
gcc -o ./make_core ./make_core.c
```

- core ファイルの生成場所を指定しておく。
- core ファイルのサイズ制限を外す。
- ASLR は切っておく。

```bash
$ sudo bash -c 'echo core.%t > /proc/sys/kernel/core_pattern'
$ ulimit -c unlimited
$ echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
$ ./make_core
555555554000-555555555000 r--p 00000000 103:01 44838307                  /home/akira/ghq/github.com/akawashiro/akawashiro.github.io/articles/core/make_core
555555555000-555555556000 r-xp 00001000 103:01 44838307                  /home/akira/ghq/github.com/akawashiro/akawashiro.github.io/articles/core/make_core
555555556000-555555557000 r--p 00002000 103:01 44838307                  /home/akira/ghq/github.com/akawashiro/akawashiro.github.io/articles/core/make_core
555555557000-555555558000 r--p 00002000 103:01 44838307                  /home/akira/ghq/github.com/akawashiro/akawashiro.github.io/articles/core/make_core
555555558000-555555559000 rw-p 00003000 103:01 44838307                  /home/akira/ghq/github.com/akawashiro/akawashiro.github.io/articles/core/make_core
555555559000-55555557a000 rw-p 00000000 00:00 0                          [heap]
7ffff7c00000-7ffff7c28000 r--p 00000000 103:01 2386144                   /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7c28000-7ffff7dbd000 r-xp 00028000 103:01 2386144                   /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7dbd000-7ffff7e15000 r--p 001bd000 103:01 2386144                   /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7e15000-7ffff7e19000 r--p 00214000 103:01 2386144                   /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7e19000-7ffff7e1b000 rw-p 00218000 103:01 2386144                   /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7e1b000-7ffff7e28000 rw-p 00000000 00:00 0
7ffff7fa5000-7ffff7fa8000 rw-p 00000000 00:00 0
7ffff7fbb000-7ffff7fbd000 rw-p 00000000 00:00 0
7ffff7fbd000-7ffff7fc1000 r--p 00000000 00:00 0                          [vvar]
7ffff7fc1000-7ffff7fc3000 r-xp 00000000 00:00 0                          [vdso]
7ffff7fc3000-7ffff7fc5000 r--p 00000000 103:01 2385802                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7fc5000-7ffff7fef000 r-xp 00002000 103:01 2385802                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7fef000-7ffff7ffa000 r--p 0002c000 103:01 2385802                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7ffb000-7ffff7ffd000 r--p 00037000 103:01 2385802                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7ffd000-7ffff7fff000 rw-p 00039000 103:01 2385802                   /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffffffdd000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]
```

- core ファイルのセグメントを見てみる。
- バッファオーバーランでどこを書こうとして Segmentation fault がおきたのかをしらべる。
  - RW がついているのがグローバル変数のおいてあるセクションのはず。
  - `/proc/self/maps` をみると `555555559000-55555557a000` が `heap` になっている。
  - `LOAD           0x0000000000004000 0x0000555555558000 0x0000000000000000` があやしいと分かった。

```bash
$ CORE_FILENAME=$(find . | grep "^./core.*" | sort -R | head -n 1)
$ readelf -l ${CORE_FILENAME}
Elf file type is CORE (Core file)
Entry point 0x0
There are 24 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  NOTE           0x0000000000000580 0x0000000000000000 0x0000000000000000
                 0x00000000000013f8 0x0000000000000000         0x0
  LOAD           0x0000000000002000 0x0000555555554000 0x0000000000000000
                 0x0000000000001000 0x0000000000001000  R      0x1000
  LOAD           0x0000000000003000 0x0000555555555000 0x0000000000000000
                 0x0000000000000000 0x0000000000001000  R E    0x1000
  LOAD           0x0000000000003000 0x0000555555556000 0x0000000000000000
                 0x0000000000000000 0x0000000000001000  R      0x1000
  LOAD           0x0000000000003000 0x0000555555557000 0x0000000000000000
                 0x0000000000001000 0x0000000000001000  R      0x1000
  LOAD           0x0000000000004000 0x0000555555558000 0x0000000000000000
                 0x0000000000001000 0x0000000000001000  RW     0x1000
  LOAD           0x0000000000005000 0x0000555555559000 0x0000000000000000
                 0x0000000000021000 0x0000000000021000  RW     0x1000
  LOAD           0x0000000000026000 0x00007ffff7c00000 0x0000000000000000
                 0x0000000000001000 0x0000000000028000  R      0x1000
  LOAD           0x0000000000027000 0x00007ffff7c28000 0x0000000000000000
                 0x0000000000000000 0x0000000000195000  R E    0x1000
  LOAD           0x0000000000027000 0x00007ffff7dbd000 0x0000000000000000
                 0x0000000000000000 0x0000000000058000  R      0x1000
  LOAD           0x0000000000027000 0x00007ffff7e15000 0x0000000000000000
                 0x0000000000004000 0x0000000000004000  R      0x1000
  LOAD           0x000000000002b000 0x00007ffff7e19000 0x0000000000000000
                 0x0000000000002000 0x0000000000002000  RW     0x1000
  LOAD           0x000000000002d000 0x00007ffff7e1b000 0x0000000000000000
                 0x000000000000d000 0x000000000000d000  RW     0x1000
  LOAD           0x000000000003a000 0x00007ffff7fa5000 0x0000000000000000
                 0x0000000000003000 0x0000000000003000  RW     0x1000
  LOAD           0x000000000003d000 0x00007ffff7fbb000 0x0000000000000000
                 0x0000000000002000 0x0000000000002000  RW     0x1000
  LOAD           0x000000000003f000 0x00007ffff7fbd000 0x0000000000000000
                 0x0000000000004000 0x0000000000004000  R      0x1000
  LOAD           0x0000000000043000 0x00007ffff7fc1000 0x0000000000000000
                 0x0000000000002000 0x0000000000002000  R E    0x1000
  LOAD           0x0000000000045000 0x00007ffff7fc3000 0x0000000000000000
                 0x0000000000001000 0x0000000000002000  R      0x1000
  LOAD           0x0000000000046000 0x00007ffff7fc5000 0x0000000000000000
                 0x0000000000000000 0x000000000002a000  R E    0x1000
  LOAD           0x0000000000046000 0x00007ffff7fef000 0x0000000000000000
                 0x0000000000000000 0x000000000000b000  R      0x1000
  LOAD           0x0000000000046000 0x00007ffff7ffb000 0x0000000000000000
                 0x0000000000002000 0x0000000000002000  R      0x1000
  LOAD           0x0000000000048000 0x00007ffff7ffd000 0x0000000000000000
                 0x0000000000002000 0x0000000000002000  RW     0x1000
  LOAD           0x000000000004a000 0x00007ffffffdd000 0x0000000000000000
                 0x0000000000022000 0x0000000000022000  RW     0x1000
  LOAD           0x000000000006c000 0xffffffffff600000 0x0000000000000000
                 0x0000000000001000 0x0000000000001000    E    0x1000
```

- 怪しいところをバイナリエディタで見てみる。
- バッファオーバーランで`0xdeadbeefdeadbeef` を書きつぶして、プログラムの先頭まで書いてページのアクセス違反で落ちたことがわかる。
  - 通常プログラムの自体は RX でロードされる。

```
$ xxd -s 0x3000 -l 0x100000 ${CORE_FILENAME}
00003000: 0100 0200 7200 2f70 726f 632f 7365 6c66  ....r./proc/self
00003010: 2f6d 6170 7300 2573 0000 0000 011b 033b  /maps.%s.......;
00003020: 3000 0000 0500 0000 04f0 ffff 6400 0000  0...........d...

============================= 省略 ================================

00003fe0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00003ff0: 0000 0000 0000 0000 a059 c4f7 ff7f 0000  .........Y......
00004000: 0000 0000 0000 0000 0880 5555 5555 0000  ..........UUUU..
00004010: efbe adde efbe adde efbe adde efbe adde  ................
00004020: efbe adde efbe adde efbe adde efbe adde  ................

============================= 省略 ================================

00025fe0: efbe adde efbe adde efbe adde efbe adde  ................
00025ff0: efbe adde efbe adde efbe adde efbe adde  ................
00026000: 7f45 4c46 0201 0103 0000 0000 0000 0000  .ELF............
00026010: 0300 3e00 0100 0000 509f 0200 0000 0000  ..>.....P.......
00026020: 4000 0000 0000 0000 f0c0 2100 0000 0000  @.........!.....

============================= 省略 ================================

0006cfe0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
0006cff0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
```

- core ファイルの `PT_NOTE` を見てみる。
- `NT_X86_XSTATE` という気になるパートがある。
  - [xsave/xrstor についての記事](https://zenn.dev/tanakmura/articles/8af62a260ff05d) に詳細がある。

```bash
$ readelf --note ./core.1687577511.931088

Displaying notes found at file offset 0x00000580 with length 0x000013f8:
  Owner                Data size 	Description
  CORE                 0x00000150	NT_PRSTATUS (prstatus structure)
  CORE                 0x00000088	NT_PRPSINFO (prpsinfo structure)
  CORE                 0x00000080	NT_SIGINFO (siginfo_t data)
  CORE                 0x00000150	NT_AUXV (auxiliary vector)
  CORE                 0x00000439	NT_FILE (mapped files)
    Page size: 4096
                 Start                 End         Page Offset
    0x0000555555554000  0x0000555555555000  0x0000000000000000
        /home/akira/ghq/github.com/akawashiro/misc/core/make_core
    0x0000555555555000  0x0000555555556000  0x0000000000000001
        /home/akira/ghq/github.com/akawashiro/misc/core/make_core
    0x0000555555556000  0x0000555555557000  0x0000000000000002
        /home/akira/ghq/github.com/akawashiro/misc/core/make_core
    0x0000555555557000  0x0000555555558000  0x0000000000000002
        /home/akira/ghq/github.com/akawashiro/misc/core/make_core
    0x0000555555558000  0x0000555555559000  0x0000000000000003
        /home/akira/ghq/github.com/akawashiro/misc/core/make_core
    0x00007ffff7c00000  0x00007ffff7c28000  0x0000000000000000
        /usr/lib/x86_64-linux-gnu/libc.so.6
    0x00007ffff7c28000  0x00007ffff7dbd000  0x0000000000000028
        /usr/lib/x86_64-linux-gnu/libc.so.6
    0x00007ffff7dbd000  0x00007ffff7e15000  0x00000000000001bd
        /usr/lib/x86_64-linux-gnu/libc.so.6
    0x00007ffff7e15000  0x00007ffff7e19000  0x0000000000000214
        /usr/lib/x86_64-linux-gnu/libc.so.6
    0x00007ffff7e19000  0x00007ffff7e1b000  0x0000000000000218
        /usr/lib/x86_64-linux-gnu/libc.so.6
    0x00007ffff7fc3000  0x00007ffff7fc5000  0x0000000000000000
        /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x00007ffff7fc5000  0x00007ffff7fef000  0x0000000000000002
        /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x00007ffff7fef000  0x00007ffff7ffa000  0x000000000000002c
        /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x00007ffff7ffb000  0x00007ffff7ffd000  0x0000000000000037
        /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
    0x00007ffff7ffd000  0x00007ffff7fff000  0x0000000000000039
        /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
  CORE                 0x00000200	NT_FPREGSET (floating point registers)
  LINUX                0x00000988	NT_X86_XSTATE (x86 XSAVE extended state)
   description data: 7f 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 80 1f 00 00 ff ff 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff ff 00 00 00 00 00 ff ff ff 00 ff ff ff 66 66 66 66 66 66 66 36 30 31 30 30 30 20 2d 2d 2f 61 6b 61 77 61 73 68 69 72 6f 2f 6d 69 73 63 20 20 20 20 20 20 2f 68 6f 6d 65 2f 61 6b 69 72 33 30 30 30 20 31 30 33 3a 30 31 20 34 33 31 35 35 35 35 35 35 38 30 30 30 2d 35 35 35 35 35 35 00 00 00 00 01 1b 03 3b 30 00 00 00 05 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 07 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 54 55 55 55 00 00 00 00
```

- core ファイル自体をパースする C++のプログラムをつくる。
  - Process ID と RIP(プログラムカウンタ)を表示する。

```cpp
#include <cstdint>
#include <elf.h>
#include <fcntl.h>
#include <memory.h>
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/procfs.h>
#include <sys/user.h>
#include <unistd.h>

#include <string>

std::string ShowNT(uint32_t type) {
  if (type == NT_PRSTATUS) {
    return "NT_PRSTATUS";
  } else if (type == NT_PRFPREG) {
    return "NT_PRFPREG";
  } else if (type == NT_PRPSINFO) {
    return "NT_PRPSINFO";
  } else if (type == NT_TASKSTRUCT) {
    return "NT_TASKSTRUCT";
  } else if (type == NT_AUXV) {
    return "NT_AUXV";
  } else if (type == NT_FILE) {
    return "NT_FILE";
  } else if (type == NT_SIGINFO) {
    return "NT_SIGINFO";
  } else if (type == NT_X86_XSTATE) {
    return "NT_X86_XSTATE";
  } else {
    return "Unknown";
  }
}

int main(int argc, char const *argv[]) {
  if (argc != 2) {
    printf("Usage: %s <path to core file>\n", argv[0]);
  }

  int fd = open(argv[1], O_RDONLY);
  size_t size = lseek(fd, 0, SEEK_END);
  size_t mapped_size = (size + 0xfff) & ~0xfff;
  const char *head = reinterpret_cast<const char *>(
      mmap(NULL, mapped_size, PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, 0));

  const Elf64_Ehdr *ehdr = reinterpret_cast<const Elf64_Ehdr *>(head);
  for (size_t pi = 0; pi < ehdr->e_phnum; pi++) {
    const Elf64_Phdr *phdr =
        (reinterpret_cast<const Elf64_Phdr *>(head + ehdr->e_phoff)) + pi;
    if (phdr->p_type == PT_NOTE) {
      size_t offset_in_note = 0;
      while (offset_in_note < phdr->p_filesz) {
        const char *note = head + phdr->p_offset + offset_in_note;
        int32_t name_size =
            (*reinterpret_cast<const int32_t *>(note) + 3) / 4 * 4;
        int32_t desc_size =
            (*(reinterpret_cast<const int32_t *>(note) + 1) + 3) / 4 * 4;
        uint32_t type = *(reinterpret_cast<const uint32_t *>(note) + 2);
        const char *name = note + 4 * 3;
        // printf("name_size: %x desc_size: %x name: %s type: %s\n", name_size,
        //        desc_size, name, ShowNT(type).c_str());

        if (type == NT_PRSTATUS) {
          const prstatus_t *prstatus =
              reinterpret_cast<const prstatus_t *>(note + 4 * 3 + name_size);
          printf("prstatus->pr_pid: %d\n", prstatus->pr_pid);
          const struct user_regs_struct *regs =
              reinterpret_cast<const struct user_regs_struct *>(
                  prstatus->pr_reg);
          printf("regs->rip: %llx\n", regs->rip);
        }

        offset_in_note += 4 * 3 + name_size + desc_size;
        // printf("phdr->p_filesz : %lx offset_in_note: %lx\n", phdr->p_filesz,
        //        offset_in_note);
      }
    }
  }
  return 0;
}
```

- PID は 931088。
- Segmentation fault が起きた RIP は 55555555528f と分かった。

```bash
$ g++ -o ./parse_core ./parse_core.cc
$ ./parse_core ${CORE_FILENAME}
prstatus->pr_pid: 931088
regs->rip: 55555555528f
```
